<div class="container">
  <div class="header1">Configure Mitigation Rules</div>
  <div>Mitigation provides you with an easy way to take an action when your app is having an unexpected behavior. The triggers
    and actions allow you to define various conditions based on request count, slow requests, memory limit on which you can
    take specific actions like restart the process, log an event or start another executable. Please note that these mitigations
    should only be considered a temporary workaround until you find the real cause for the issue causing the unexpected behavior
  </div>

  <div class="col" *ngIf="retrievingAutohealSettings" style="margin-top: 15px;">
    <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true"></i>
    Retrieving autoHealing settings...
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger" style="margin-top:5px">
    {{ errorMessage }}
  </div>

  <div *ngIf="!retrievingAutohealSettings">
    <div style="margin-top: 15px;">
      <toggle-button ToggleText="Auto-Healing Enabled" [selected]="autohealingSettings.autoHealEnabled" (selectedChange)="autohealingSettings.autoHealEnabled = $event; checkForChanges()"></toggle-button>
    </div>

    <div *ngIf="autohealingSettings.autoHealEnabled">
      <div class="header2">1. Define Conditions</div>
      <div class="tile-content">
        <ng-container *ngFor="let trigger of triggers; let i = index;">
          <div class="tile" tabindex="0" (click)="updateTriggerStatus(i)" [class.active]="triggerSelected ===  i" [class.activeAction]="triggers[i].IsConfigured">
            <div class="tile-icon">
              <div class="icon-template">
                <i [class]="trigger.Icon"></i>
              </div>
              <div>{{ trigger.Name }}</div>
            </div>
          </div>
        </ng-container>

        <div class="forminput" *ngIf="triggerSelected >= 0">
          <autohealing-slowrequests-rule *ngIf="triggerSelected === 0" [rule]="autohealingSettings.autoHealRules.triggers.slowRequests"
            (ruleChange)="triggerRuleUpdated($event, triggerSelected)"></autohealing-slowrequests-rule>
          <autohealing-memory-rule *ngIf="triggerSelected === 1" [rule]="autohealingSettings.autoHealRules.triggers.privateBytesInKB"
            (ruleChange)="triggerRuleUpdated($event, triggerSelected)"></autohealing-memory-rule>
          <autohealing-requests-rule *ngIf="triggerSelected === 2" [rule]="autohealingSettings.autoHealRules.triggers.requests" (ruleChange)="triggerRuleUpdated($event, triggerSelected)"></autohealing-requests-rule>
          <autohealing-statuscodes-rule *ngIf="triggerSelected === 3" [rule]="autohealingSettings.autoHealRules.triggers.statusCodes"
            (ruleChange)="triggerRuleUpdated($event, triggerSelected)"></autohealing-statuscodes-rule>
        </div>
      </div>

      <div class="header2">2. Configure Actions</div>
      <div class="tile-content">
        <ng-container *ngFor="let action of actions; let i = index;">
          <div class="tile" [class.activeAction]="actionSelected == i" (click)="updateActionStatus(i)">
            <div class="tile-icon">
              <div class="icon-template">
                <i [class]="action.Icon" aria-hidden="true"></i>
              </div>
              <div>{{ action.Name }} </div>
            </div>
          </div>
        </ng-container>

        <div [hidden]="actionSelected != 2 || actionCollapsed">
          <autohealing-custom-action [siteToBeDiagnosed]="siteToBeDiagnosed" [customAction]="customAction" (customActionChanged)="updateCustomAction($event)"></autohealing-custom-action>
        </div>
      </div>

      <div>
        <div class="header2">3. Review and Save your Settings</div>
        <div class="summary tile-content">
          <div *ngIf="originalSettings">
            <strong>Current Settings</strong>
            <autohealing-config-summary [autohealSettings]="originalSettings">
            </autohealing-config-summary>
          </div>
          <div *ngIf="currentSettings && saveEnabled" style="margin-top:25px">
            <strong>New Settings</strong>
            <autohealing-config-summary [autohealSettings]="currentSettings">
            </autohealing-config-summary>
          </div>
          <collapsible-list title="Modify Startup Time" [collapsed]="startupTimeCollapsed" (onSelect)="startupTimeCollapsed = !startupTimeCollapsed">
            <collapsible-list-item [marginTop]="10">
              <label for="minProcessExecutionTime">Configure the minimum time the process must execute before taking the action. This is useful specially in scenarios
                where your App has a high startup time and you don't want the mitigation action to kick in during that time.
                It is advisable to configure this duration to be more than the startup time that the app usually takes.
              </label>
              <div class="row">
                <div class="col-xs-4" style="padding-left:5px; margin-top:5px">
                  <input type="number" id="minProcessExecutionTime" placeholder="e.g. 60" [ngModel]="minProcessExecutionTime" (input)="saveMinProcessTimeChanged($event.target.value)">
                </div>
              </div>
            </collapsible-list-item>
          </collapsible-list>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!retrievingAutohealSettings" class="saveSection tile-content">
    <button type="button" class="btn btn-primary" [disabled]="!saveEnabled" (click)="saveChanges()">Save</button>
    <div *ngIf="savingAutohealSettings" class="inline">
      <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true"></i>
      Saving AutoHeal settings...
    </div>
    <div *ngIf="changesSaved" class="inline" style="color:#0058ad">
      Changes Saved !!!
    </div>
  </div>